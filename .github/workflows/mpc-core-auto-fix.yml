name: MPC Core è‡ªåŠ¨ä¿®å¤

on:
  workflow_run:
    workflows: ["MPC Core ä¸“é¡¹æµ‹è¯•"]
    types:
      - completed

jobs:
  analyze-failures:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
    - name: ä¸‹è½½æµ‹è¯•æŠ¥å‘Š
      uses: actions/download-artifact@v3
      with:
        name: mpc-core-test-results
        path: /tmp/test-results
    
    - name: åˆ†æå¤±è´¥åŸå› 
      run: |
        echo "ğŸ” åˆ†æ MPC Core æµ‹è¯•å¤±è´¥åŸå› ..."
        # è¿™é‡Œå¯ä»¥é›†æˆ AI åˆ†æå·¥å…·
        echo "ğŸ“‹ å»ºè®®ä¿®å¤æ–¹æ¡ˆ:"
        echo "1. æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬å…¼å®¹æ€§"
        echo "2. éªŒè¯ Rust ç¼–è¯‘å™¨ç‰ˆæœ¬"
        echo "3. è¿è¡Œ cargo update"
        echo "4. æ£€æŸ¥æµ‹è¯•ç¯å¢ƒé…ç½®"
    
    - name: åˆ›å»ºä¿®å¤ Issue
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `[è‡ªåŠ¨ä¿®å¤] MPC Core æµ‹è¯•å¤±è´¥ - ${new Date().toISOString()}`,
            body: `æµ‹è¯•è¿è¡Œå¤±è´¥ï¼Œéœ€è¦äººå·¥æ£€æŸ¥ä»¥ä¸‹é—®é¢˜ï¼š\n\n1. å•å…ƒæµ‹è¯•å¤±è´¥è¯¦æƒ…\n2. é›†æˆæµ‹è¯•ç¯å¢ƒé—®é¢˜\n3. ä¾èµ–å…¼å®¹æ€§é—®é¢˜\n\nè¯·æŸ¥çœ‹æµ‹è¯•æŠ¥å‘Šå¹¶ä¿®å¤ã€‚`,
            labels: ['bug', 'mpc-core', 'auto-generated']
          })

  auto-fix-attempt:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    needs: analyze-failures
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: å°è¯•è‡ªåŠ¨ä¿®å¤
      run: |
        echo "ğŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤..."
        cd mpc-core
        # å°è¯•æ›´æ–°ä¾èµ–
        cargo update
        # æ¸…ç†æ„å»ºç¼“å­˜
        cargo clean
        echo "âœ… è‡ªåŠ¨ä¿®å¤æ­¥éª¤å®Œæˆï¼Œè¯·é‡æ–°è¿è¡Œæµ‹è¯•"