name: MPC Core 专项测试

on:
  push:
    paths:
      - 'mpc-core/**'
  pull_request:
    paths:
      - 'mpc-core/**'

jobs:
  mpc-core-unit-tests:
    runs-on: ubuntu-latest
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置Rust环境
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        components: clippy, rustfmt
    
    - name: 运行单元测试
      run: |
        cd mpc-core
        cargo test --verbose -- --nocapture
    
    - name: 代码质量检查
      run: |
        cd mpc-core
        cargo clippy -- -D warnings
        cargo fmt -- --check
    
    - name: 生成测试报告
      run: |
        cd mpc-core
        cargo test -- --format=json > test-results.json
    
    - name: 上传测试报告
      uses: actions/upload-artifact@v3
      with:
        name: mpc-core-test-results
        path: mpc-core/test-results.json
        retention-days: 30

  mpc-core-integration:
    runs-on: ubuntu-latest
    needs: mpc-core-unit-tests
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 构建Release版本
      run: |
        cd mpc-core
        cargo build --release
    
    - name: 运行集成测试
      run: |
        cd mpc-core
        # 添加您的MPC集成测试脚本
        ./scripts/mpc-integration-test.sh
    
    - name: 性能基准测试
      run: |
        cd mpc-core
        cargo bench --verbose

  mpc-security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: Rust安全审计
      run: |
        cd mpc-core
        cargo install cargo-audit
        cargo audit
    
    - name: 依赖漏洞扫描
      uses: actions/dependency-review-action@v3