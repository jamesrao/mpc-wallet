name: MPCé’±åŒ…ä¼˜åŒ–CI/CDæµæ°´çº¿

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨å®‰å…¨æ‰«æ

env:
  NODE_VERSION: '18'
  GO_VERSION: '1.23'
  RUST_VERSION: 'stable'

jobs:
  # 1. ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¤šè¯­è¨€ï¼‰
  code-quality:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: å¤šè¯­è¨€ä»£ç è´¨é‡æ£€æŸ¥
      uses: github/super-linter@v4
      env:
        VALIDATE_ALL_CODEBASE: false
        VALIDATE_JAVASCRIPT_ES: true
        VALIDATE_TYPESCRIPT_ES: true
        VALIDATE_GO: true
        VALIDATE_RUST: true
        DEFAULT_BRANCH: main

  # 2. å‰ç«¯æ„å»ºæµ‹è¯•
  frontend-build:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend-web/package-lock.json
    
    - name: å®‰è£…ä¾èµ–å’Œæ„å»º
      run: |
        cd frontend-web
        npm ci
        npm run build
        npm run lint
    
    - name: Lighthouseæ€§èƒ½æµ‹è¯•
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './lighthouse.config.js'
        uploadArtifacts: true

  # 3. åç«¯Goæµ‹è¯•
  backend-tests:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
        cache-dependency-path: backend-services/api/go.sum
    
    - name: Goæ„å»ºå’Œæµ‹è¯•
      run: |
        cd backend-services/api
        go build -v ./...
        go test -v ./... -coverprofile=coverage.out
        go tool cover -html=coverage.out -o coverage.html
    
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: go-coverage-report
        path: backend-services/api/coverage.html

  # 4. MPCæ ¸å¿ƒRustæµ‹è¯•
  mpc-core-tests:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: Rustç¼“å­˜
      uses: actions/cache@v3
      with:
        path: mpc-core/target
        key: ${{ runner.os }}-rust-${{ hashFiles('mpc-core/Cargo.lock') }}
    
    - name: Rustæ„å»ºå’Œæµ‹è¯•
      run: |
        cd mpc-core
        cargo build --release
        cargo test --verbose
        cargo clippy -- -D warnings

  # 5. å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: CodeQLå®‰å…¨åˆ†æ
      uses: github/codeql-action/init@v2
      with:
        languages: javascript, typescript, go, rust
    
    - name: æ‰§è¡Œå®‰å…¨åˆ†æ
      uses: github/codeql-action/analyze@v2
    
    - name: ä¾èµ–å®‰å…¨å®¡æŸ¥
      uses: actions/dependency-review-action@v3

  # 6. é›†æˆæµ‹è¯•
  integration-tests:
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-tests, mpc-core-tests]
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: mpc_wallet_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
      run: docker-compose -f docker-compose.test-minimal.yml up -d
    
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        # ç­‰å¾…æœåŠ¡å°±ç»ª
        ./scripts/wait-for-services.sh
        # è¿è¡Œç«¯åˆ°ç«¯æµ‹è¯•
        npm run test:e2e

  # 7. éƒ¨ç½²ï¼ˆä»…mainåˆ†æ”¯ï¼‰
  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: [code-quality, frontend-build, backend-tests, mpc-core-tests, security-scan, integration-tests]
    environment: production
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: æ„å»ºDockeré•œåƒ
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: mpc-wallet:latest
    
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      run: |
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        echo "æäº¤: ${{ github.sha }}"
        # è¿™é‡Œæ·»åŠ æ‚¨çš„å®é™…éƒ¨ç½²è„šæœ¬
        ./scripts/deploy-prod.sh
      env:
        DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}

  # 8. é€šçŸ¥å’ŒæŠ¥å‘Š
  notify:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
    - name: å‘é€é€šçŸ¥
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}