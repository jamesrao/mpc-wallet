# 系统架构设计文档

## 概述

MPC企业级Web3钱包是一个基于门限签名技术（MPC）的区块链钱包系统，专注于跨境电商和供应链金融场景。本文档详细描述系统架构设计。

## 设计原则

### 核心原则
1. **安全第一**: 私钥永不完整出现，采用多重安全防护
2. **合规导向**: 符合国内外监管要求，支持KYC/AML
3. **高性能**: 支持高并发交易，响应时间<500ms
4. **可扩展**: 微服务架构，支持水平扩展
5. **生态友好**: 与Meta生态深度集成，支持多链

### 架构决策
- **MPC协议**: 选择GG18/GG20协议，成熟稳定，社区支持好
- **编程语言**: Rust（安全关键），Go（业务逻辑），TypeScript（前端）
- **数据库**: PostgreSQL（事务），Redis（缓存），ClickHouse（分析）
- **部署**: Kubernetes云原生部署，支持多区域部署

## 整体架构

### 分层架构（集成 Passkey）
```
┌─────────────────────────────────────────────────────────────┐
│                   客户端层 (Client Layer)                    │
├─────────────────────────────────────────────────────────────┤
│  Web前端  │  移动端  │  Passkey认证  │  管理后台  │  区块链钱包  │
└─────────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────────┐
│                   Passkey 服务层 (Passkey Service Layer)     │
├─────────────────────────────────────────────────────────────┤
│  WebAuthn服务 │  密钥管理  │  挑战响应  │  设备绑定  │  生物识别集成│
└─────────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────────┐
│                   网关层 (Gateway Layer)                     │
├─────────────────────────────────────────────────────────────┤
│  API网关  │  负载均衡  │  安全防护  │  限流熔断  │  协议转换  │
└─────────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────────┐
│                   应用服务层 (Application Layer)             │
├─────────────────────────────────────────────────────────────┤
│ 用户服务 │ 资产服务 │ 交易服务 │ Passkey服务 │ 风控服务 │ 审计服务 │
└─────────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────────┐
│                   核心服务层 (Core Service Layer)            │
├─────────────────────────────────────────────────────────────┤
│  MPC服务集群  │  区块链中间件  │  消息队列  │  缓存集群  │
└─────────────────────────────────────────────────────────────┘
                               │
┌─────────────────────────────────────────────────────────────┐
│                   基础设施层 (Infrastructure Layer)          │
├─────────────────────────────────────────────────────────────┤
│  数据库集群  │  区块链节点  │  文件存储  │  监控告警  │
└─────────────────────────────────────────────────────────────┘
```

### 组件说明

#### 1. 客户端层
- **Web前端**: TypeScript + React，响应式设计，支持桌面和移动浏览器
- **移动端**: React Native，iOS和Android原生体验
- **开放平台**: API接口和SDK，供第三方集成
- **管理后台**: 企业级管理界面，支持多租户
- **区块链钱包**: 浏览器插件钱包，支持直接与DApp交互

#### 2. 网关层
- **API网关**: Kong/Traefik，路由、认证、限流
- **负载均衡**: Nginx/HAProxy，流量分发
- **安全防护**: WAF，DDoS防护，API安全
- **限流熔断**: 防止系统过载，保证稳定性
- **协议转换**: REST/WebSocket/GraphQL协议转换

#### 3. 应用服务层
- **用户服务**: 用户注册、登录、KYC认证
- **资产服务**: 资产查询、余额更新、价格获取
- **交易服务**: 交易创建、签名、广播、状态跟踪
- **Passkey服务**: WebAuthn认证、生物识别管理、设备绑定、密钥管理
- **风控服务**: 交易风控、反欺诈、AML监控
- **审批服务**: 多级审批流程、权限控制
- **审计服务**: 操作日志、合规审计、报表生成

#### 4. 核心服务层
- **MPC服务集群**: 密钥生成、签名、分片管理
- **区块链中间件**: 多链适配、节点管理、交易构造
- **消息队列**: Kafka/RabbitMQ，异步解耦
- **缓存集群**: Redis Cluster，热点数据缓存

#### 5. 基础设施层
- **数据库集群**: PostgreSQL主从、读写分离
- **区块链节点**: 以太坊、Polygon、BSC等全节点
- **文件存储**: S3兼容对象存储
- **监控告警**: Prometheus、Grafana、告警系统

## 核心模块设计

### MPC服务架构

#### 1. 节点设计
```rust
pub struct MPCNode {
    node_id: String,
    key_share: SecVec<u8>, // 安全内存存储
    enclave: SgxEnclave,   // 可信执行环境
    network_endpoint: Url,
    health_status: NodeHealth,
    performance_metrics: NodeMetrics,
}
```

#### 2. 集群管理
- **节点发现**: 基于Consul/Etcd的服务发现
- **负载均衡**: 轮询或一致性哈希分配请求
- **故障转移**: 自动故障检测和恢复
- **动态扩容**: 根据负载自动扩缩容

#### 3. 协议实现
- **密钥生成**: GG18协议，支持2-3、3-5等门限方案
- **签名协议**: GG20协议，支持ECDSA/EdDSA
- **安全增强**: Intel SGX/TEE保护，HSM硬件支持

### 区块链中间件

#### 1. 多链支持架构
```
                      ┌─────────────┐
                      │  统一API层   │
                      └─────────────┘
                              │
        ┌──────────┬──────────┼──────────┬──────────┐
        │          │          │          │          │
    ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐
    │以太坊│    │Polygon│   │BSC   │    │比特币│    │专有链│
    │适配器│    │适配器 │   │适配器│    │适配器│    │适配器│
    └─────┘    └─────┘    └─────┘    └─────┘    └─────┘
```

#### 2. 功能模块
- **链适配器**: 统一接口，适配不同区块链
- **节点管理**: 节点健康检查、负载均衡
- **交易池**: 交易缓存、排序、Gas优化
- **事件监听**: 区块链事件监听和解析

### 智能合约架构

#### 1. 支付担保合约
```solidity
contract EscrowPayment {
    enum PaymentStatus { Created, Paid, Shipped, Confirmed, Disputed, Refunded }
    
    struct Transaction {
        address buyer;
        address seller;
        uint256 amount;
        uint256 createTime;
        PaymentStatus status;
        address arbitrator; // 仲裁员地址
    }
    
    // 创建支付订单
    function createPayment(bytes32 orderId, address seller) external payable;
    
    // 确认收货
    function confirmDelivery(bytes32 orderId) external;
    
    // 发起争议
    function raiseDispute(bytes32 orderId, string memory reason) external;
    
    // 仲裁裁决
    function arbitrate(bytes32 orderId, uint256 buyerShare, uint256 sellerShare) external;
}
```

#### 2. 供应链金融合约
```solidity
contract SupplyChainFinance {
    // 应收账款Token化
    function tokenizeReceivable(
        uint256 invoiceId,
        uint256 amount,
        uint256 dueDate,
        address supplier,
        address buyer
    ) external returns (uint256 tokenId);
    
    // 融资申请
    function applyForFinancing(uint256 tokenId, uint256 financingAmount) external;
    
    // 自动还款
    function repay(uint256 tokenId) external;
}
```

### Passkey 认证架构

#### 1. 技术组件
- **前端 WebAuthn API**: 浏览器/设备原生生物识别调用
- **Passkey 服务**: 密钥对生成、挑战管理、签名验证
- **设备绑定存储**: 安全存储用户设备绑定信息
- **生物识别适配器**: 跨平台生物识别技术适配

#### 2. 用户流程
```
注册流程:
用户注册 → 生物识别验证 → 生成Passkey密钥对 → 绑定用户账户 → 安全存储

登录流程:
访问应用 → Passkey登录选项 → 生物识别验证 → 挑战响应验证 → 生成会话

交易确认流程:
发起交易 → 生物识别验证 → MPC签名调用 → 交易广播 → 区块链确认
```

#### 3. 安全设计
- **零密码存储**: 完全消除密码存储和管理风险
- **设备硬件绑定**: 私钥存储在设备安全区域，无法导出
- **抗网络攻击**: 每次认证使用唯一挑战值，防止重放攻击
- **生物识别保护**: 需要物理身份验证，防止未授权访问

## 数据架构

### 数据库设计
#### 1. 业务数据库（PostgreSQL）
- **用户相关**: users, organizations, user_organizations
- **钱包相关**: wallets, mpc_key_shares, assets
- **交易相关**: transactions, payment_orders, supply_chain_receivables
- **审批相关**: approvals, audit_logs

#### 2. 缓存设计（Redis）
- **会话缓存**: 用户会话、登录状态
- **热点数据**: 资产价格、费率信息
- **分布式锁**: 防止并发操作
- **队列**: 异步任务队列

#### 3. 分析数据库（ClickHouse）
- **交易分析**: 交易统计、用户行为
- **风控数据**: 异常模式、风险评分
- **业务报表**: 财务报表、运营指标

### 数据流设计
```
用户操作 → API网关 → 应用服务 → 核心服务 → 区块链
      ↓          ↓          ↓          ↓         ↓
    Redis     PostgreSQL   Kafka    PostgreSQL 区块链节点
      ↓          ↓          ↓          ↓
    ClickHouse ←───── 数据同步 ─────→ 监控系统
```

## 安全架构

### 1. 密码学安全
- **MPC协议**: GG18/GG20，门限签名
- **密钥管理**: 分片存储，单点无法还原
- **安全存储**: HSM硬件加密，TEE可信环境
- **传输加密**: TLS 1.3，端到端加密

### 2. 应用安全
- **身份认证**: JWT + 多因素认证
- **权限控制**: RBAC基于角色的访问控制
- **输入验证**: 严格的输入验证和过滤
- **防攻击**: WAF，DDoS防护，速率限制

### 3. 数据安全
- **数据加密**: 静态数据加密，传输加密
- **数据隔离**: 多租户数据隔离
- **备份恢复**: 定期备份，灾难恢复
- **数据脱敏**: 敏感信息脱敏处理

### 4. 合规安全
- **KYC/AML**: 身份验证，反洗钱监控
- **审计跟踪**: 完整操作日志，不可篡改
- **隐私保护**: GDPR合规，数据最小化
- **监管报告**: 自动生成监管报告

### 5. 无密码认证安全
- **WebAuthn 协议**: 基于W3C标准，使用公钥密码学替代传统密码
- **生物识别集成**: 设备原生安全模块（TPM、Secure Enclave）保护
- **设备绑定策略**: 密钥与设备硬件唯一绑定，防止跨设备攻击
- **防钓鱼机制**: 域名验证和用户确认，防止钓鱼网站攻击

## 部署架构

### 1. 开发环境
- Docker Compose本地部署
- 完整服务栈，便于开发调试
- 自动数据库迁移和初始化

### 2. 测试环境
- Kubernetes集群部署
- 与生产环境相似的配置
- 自动化测试流水线

### 3. 生产环境
- **区域部署**: 多区域部署，容灾备份
- **服务网格**: Istio服务治理
- **监控体系**: Prometheus + Grafana + ELK
- **CDN加速**: 静态资源CDN加速

### 4. 多云部署
```
           ┌─────────────────┐
           │   云服务商A     │
           │  (主生产环境)   │
           └─────────────────┘
                   │
    ┌──────────────┼──────────────┐
    │              │              │
┌─────┐        ┌─────┐        ┌─────┐
│区域1│        │区域2│        │区域3│
│(中国)│        │(美国)│        │(欧洲)│
└─────┘        └─────┘        └─────┘
    │              │              │
    └──────────────┼──────────────┘
                   │
           ┌─────────────────┐
           │   云服务商B     │
           │  (备份环境)     │
           └─────────────────┘
```

## 性能优化

### 1. 缓存策略
- **L1缓存**: 本地内存缓存，高频数据
- **L2缓存**: Redis集群，共享缓存
- **CDN缓存**: 静态资源，全球加速

### 2. 数据库优化
- **读写分离**: 主库写，从库读
- **分库分表**: 按用户ID或时间分片
- **索引优化**: 复合索引，覆盖索引

### 3. 异步处理
- **消息队列**: 非实时操作异步处理
- **批处理**: 批量操作减少IO
- **流处理**: 实时数据处理

### 4. 网络优化
- **连接池**: 数据库和外部服务连接池
- **压缩传输**: Gzip压缩，减少带宽
- **协议优化**: HTTP/2，WebSocket

## 监控与运维

### 1. 监控指标
- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: QPS、响应时间、错误率
- **业务指标**: 交易量、用户数、资产规模
- **安全指标**: 攻击尝试、异常登录

### 2. 告警系统
- **多级告警**: 警告、严重、紧急
- **多渠道通知**: 邮件、短信、钉钉、电话
- **智能降噪**: 告警聚合，避免告警风暴

### 3. 日志系统
- **集中日志**: ELK Stack收集和分析
- **结构化日志**: JSON格式，便于查询
- **审计日志**: 安全合规要求

### 4. 运维工具
- **自动化部署**: CI/CD流水线
- **配置管理**: 集中配置，动态更新
- **故障排查**: 分布式跟踪，性能分析

## 扩展性设计

### 1. 水平扩展
- **无状态服务**: 应用服务无状态设计
- **数据分片**: 数据库水平分片
- **负载均衡**: 自动流量分发

### 2. 垂直扩展
- **服务拆分**: 微服务粒度适中
- **功能模块化**: 插件化架构
- **API版本化**: 向后兼容，平滑升级

### 3. 生态扩展
- **多链支持**: 插件化链适配器
- **生态集成**: Meta生态深度集成
- **开放平台**: API和SDK支持

## 风险评估与应对

### 1. 技术风险
- **MPC技术成熟度**: 与浙大实验室合作，确保技术可靠性
- **区块链性能**: 采用Layer2和侧链技术优化
- **系统复杂度**: 模块化设计，逐步迭代

### 2. 业务风险
- **监管政策**: 建立合规团队，及时调整策略
- **市场竞争**: 依托技术优势和生态资源建立壁垒
- **用户接受度**: 渐进式推广，用户体验优化

### 3. 运营风险
- **安全事件**: 多层安全防护，应急响应预案
- **系统故障**: 多区域部署，容灾备份
- **数据丢失**: 多重备份，定期恢复测试

## 附录

### 技术选型清单
- **编程语言**: Rust, Go, TypeScript, Solidity
- **数据库**: PostgreSQL, Redis, ClickHouse
- **消息队列**: Kafka/RabbitMQ
- **容器编排**: Kubernetes
- **服务网格**: Istio
- **监控系统**: Prometheus, Grafana, ELK
- **认证协议**: WebAuthn (W3C标准), FIDO2
- **生物识别**: 设备原生人脸识别、指纹识别
- **安全存储**: TPM 2.0, Apple Secure Enclave, Android Keystore
- **前端支持**: @simplewebauthn/browser, Web Authentication API
- **后端支持**: @simplewebauthn/server, go-webauthn
- **区块链节点**: Geth, Polygon, BSC

### 性能目标
- 单笔交易处理时间: < 3秒
- 系统并发支持: > 10,000 TPS
- 钱包响应时间: < 500ms
- 系统可用性: 99.99%

### 安全标准
- 密码学标准: NIST FIPS 140-2
- 安全认证: ISO 27001, SOC 2
- 合规要求: 中国密码法, GDPR, AML